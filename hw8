8.7
'''Давайте посмотрим на продажи авокадо в двух городах (NewYork, LosAngeles) и узнаем, сколько авокадо типа organic было продано в целом к концу каждой недели (накопительная сумма продаж), начиная с начала периода наблюдений (04/01/15). Пример результирующей таблицы:''
SELECT
    region,
    date,
    total_volume,
    SUM(total_volume) OVER w AS volume
FROM 
    avocado
WHERE region in ('NewYork' , 'LosAngeles') and type ='organic' and date >= '01/04/15'
WINDOW w AS
    (
    PARTITION BY region
    ORDER BY date ASC
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    )
ORDER BY
    region DESC,
    date ASC
    
  8.8
    '''
    Теперь добавьте разбиение по каждому году (year). Таким образом, в конце февраля 2016 года объем составит уже не продажи за 2015 и январь-февраль 2016, а только январь-февраль 2016.
Когда объемы продаж органических авокадо в Нью-Йорке превысили объемы продаж в Лос-Анджелесе?
Для решения задачи постройте график объема продаж в двух городах, где по оси X будет лежать дата. '''
SELECT
    region,
    date_part('year', date) as year,  
    date,
    total_volume,
    SUM(total_volume) OVER w AS volume
FROM 
    avocado
WHERE region in ('NewYork' , 'LosAngeles') and type ='organic' and date >= '01/04/15'
WINDOW w AS
    (
    PARTITION BY region,year
    ORDER BY date ASC
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    )
ORDER BY
    region DESC,
    date ASC
    
8.9
'''Посмотрим, когда объемы продаж обычных (conventional) авокадо резко падали по сравнению с предыдущей неделей. Возьмите данные по США в целом, посчитайте разницу между объемом продаж в неделю x (total_volume) и количеством проданных авокадо в течение предыдущей недели. Значения запишите в новый столбец week_diff.

type – тип авокадо (conventional)
region – регион (TotalUS)
total_volume – объем продаж за неделю'''

SELECT
    region,
    
    --date_part('year', date) as year,  
    date,
    total_volume,
    --SUM(total_volume) OVER w AS volume,
    total_volume - LAG(total_volume, 1) OVER w AS week_diff  
    --lag(volume,7)- volume AS week_diff   
FROM 
    avocado
WHERE region in ('TotalUS') and type ='conventional' and date >= '01/04/15'
WINDOW w AS
    (
    PARTITION BY region
    --, week_diff
    --,year
    ORDER BY date ASC
    ---ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    )
ORDER BY
    region DESC,
    date ASC
